<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Entraîneur de prononciation IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <script
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
      type="text/javascript"
    ></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container">
      <div class="flex-md-row">
        <div class="main-content">
          <h1 class="mb-4">Entraîneur de prononciation IA</h1>

          <div class="mb-3">
            <label for="category" class="form-label"
              >Sélectionnez la catégorie :</label
            >
            <select class="form-select" id="category" name="category">
              <!-- Cuisine et transport -->
              <optgroup label="Pharses Metro-boulout-dôdo">
                <option value="transport">transport</option>
                <option value="aeroport">transport</option>
                <option value="rue">rue</option>
                <option value="hotel">hotel</option>
                <option value="restaurant">restaurant</option>
                <option value="magasin">magasin</option>
                <option value="supermarche">supermarche</option>
                <option value="pharmacie">pharmacie</option>
                <option value="police">police</option>
                <option value="musee">musee</option>
              </optgroup>

              <!-- Santé / Trinquer -->
              <optgroup label="Expressions Courants">
                <option value="sante_trinquer">Santé / Trinquer</option>
                <option value="eternuer">Éternuer</option>
                <option value="bonne_chance">Bonne chance</option>
                <option value="felicitations">Félicitations</option>
                <option value="anniversaire">Anniversaire</option>
                <option value="bonne_fete">Bonne fête</option>
                <option value="bonne_soiree">Bonne soirée</option>
                <option value="voyage_trajet">Voyage / Trajet</option>
                <option value="appetit">Bon appétit</option>
                <option value="fetes_specifiques">Fêtes spécifiques</option>
                <option value="bonne_annee">Bonne année</option>
                <option value="condoleances">Condoléances</option>
                <option value="PROPOSER QUELQUE CHOSE">
                  PROPOSER QUELQUE CHOSE
                </option>
                <option value="REPONDRE_POSITIVEMENT">
                  REPONDRE_POSITIVEMENT
                </option>
                <option value="REPONDRE_NÉGATIVEMENT">
                  RÉPONDRE NÉGATIVEMENT
                </option>
                <option value="DEMANDER_DES_INFORMATIONS">
                  DEMANDER DES INFORMATIONS
                </option>
                <option value="DEMANDER_DE_L’AIDE">DEMANDER DE L’AIDE</option>
                <option value="EXCUSES">EXCUSES</option>
                <option value="REMERCIEMENTS">REMERCIEMENTS</option>
              </optgroup>

              <!-- Grammaire -->
              <optgroup label="Grammaire">
                <option value="Expressions_en_Conditionnel_Present">
                  Expressions en Conditionnel Présent
                </option>
                <option value="Expressions_avec_pronom_Y">
                  Expressions_avec_pronom_Y
                </option>
                <option value="Expressions_avec_pronom_EN">
                  Expressions_avec_pronom_EN
                </option>
                <option value="Subjonctif_sentences">
                  Expressions en Subjonctif
                </option>
                <option value="Expressions_en_Imperatif">
                  Expressions en Impératif
                </option>
                <option value="Expressions_en_Futur_Simple">
                  Expressions en Futur Simple
                </option>
                <option value="Expressions_en_Passe_Compose">
                  Expressions en Passé Composé
                </option>
                <option value="Expressions_en_Present_Continu_Gerondif">
                  Expressions en Présent Continu / Gérondif
                </option>
                <option value="Expressions_en_Passe_Recent">
                  Expressions en Passé Récent
                </option>
                <option value="Expressions_en_Imparfait">
                  Expressions en Imparfait
                </option>
                <option value="Expressions_en_Plus_Que_Parfait">
                  Expressions en Plus-Que-Parfait
                </option>
                <option value="Expressions_en_Futur_Proche">
                  Expressions en Futur Proche
                </option>
                <option value="Phrases_avec_de">Phrases avec "de"</option>
                <option value="Phrases_avec_a">Phrases avec "à"</option>
                <option value="Phrases_avec_en">Phrases avec "en"</option>
                <option value="Phrases_avec_COI">Phrases avec COI</option>
                <option value="Phrases_avec_COD">Phrases avec COD</option>
                <option value="Connecteurs">Connecteurs</option>
                <option value="Conjugaison3">Conjugaison 3</option>
                <option value="Conjugaison2">Conjugaison 2</option>
                <option value="Pronominaux">Pronominaux</option>
                <option value="Phrases_avec_y">Phrases avec "y"</option>
              </optgroup>

              <!-- Autres -->
              <optgroup label="Autres">
                <option value="Donner_la_date">Donner la date</option>
                <option value="Donner_l_heure">Donner l'heure</option>
                <option value="Indiquer_la_frequence">
                  Indiquer la fréquence
                </option>
                <option value="Exprimer_une_condition">
                  Exprimer_une_condition
                </option>
                <option value="Donner_un_conseil">Donner_un_conseil</option>
                <option value="Exprimer_la_condition">
                  Exprimer_la_condition
                </option>
                <option value="Exprimer_un_souhait">Exprimer_un_souhait</option>
                <option value="Exprimer_ses_emotions_et_ses_sentiments">
                  Exprimer_ses_emotions_et_ses_sentiments
                </option>
                <option value="Situer_dans_le_temps_et_exprimer_la_duree">
                  Situer dans le temps et exprimer la durée
                </option>
                <option value="Parler_d_Internet_et_des_reseaux_sociaux">
                  Parler d'Internet et des réseaux sociaux
                </option>
                <option value="comparatif">Le comparatif</option>
                <option value="superlatif">Le superlatif</option>
                <option value="formation_des_adverbes">
                  formation_des_adverbes
                </option>
                <option value="negation">La negation</option>
              </optgroup>
            </select>
          </div>

          <div class="mb-3">
            <label for="text" class="form-label"
              >Écrivez ou générez un texte ci-dessous :</label
            >
            <textarea class="form-control" id="text" name="text"></textarea>
          </div>

          <div class="classButton">
            <p
              id="statusMessage"
              style="
                display: none;
                font-weight: bold;
                color: red;
                text-align: center;
                font-size: 12px;
              "
            ></p>
            <button
              class="btn btn-success"
              id="generateButton"
              onclick="generateSentence()"
            >
              Générer une phrase
            </button>
            <button
              class="btn btn-danger"
              id="recordButton"
              onclick="toggleRecording()"
            >
              <span
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                Parler
                <i class="material-icons" id="recordIcon">mic</i>
              </span>
            </button>
            <button
              class="btn btn-primary"
              id="speakButton"
              onclick="speakText()"
            >
              Écouter le texte
            </button>
          </div>

          <!-- Player de áudio fixo -->
          <audio id="ttsAudio" controls></audio>

          <div class="pronunciation-feedback mt-4">
            <h3 class="form-label">Prononciation:</h3>
            <h3 id="pronunciation"></h3>
          </div>

          <div id="hintsContainer" class="mt-3">
            <h4>Dicas de prononciation:</h4>
            <ul id="hintsList"></ul>
          </div>

          <!-- Mensagem de upload -->
          <div
            class="uploading-message mt-3"
            id="uploadingMessage"
            style="display: none"
          >
            <span id="uploadingText">Envoi audio... Attendre.</span>
            <progress
              id="uploadProgress"
              value="0"
              max="100"
              style="width: 100%"
            ></progress>
          </div>

          <div class="result mt-4">
            <h3>Feedback:</h3>
            <p>Taux de réussite: <span id="ratio"></span>%</p>
            <div class="diff" id="diff"></div>
            <br />
            <p>Taux d’achèvement: <span id="completeness"></span>%</p>
          </div>
          <div id="audioContainer" class="mt-4"></div>
        </div>

        <div class="feedback-box" id="feedbackBox">
          <p id="feedbackContent">
            Cliquez sur un mot pour voir sa prononciation comparée.
          </p>
        </div>
      </div>
    </div>

    <script>

       // Vamos guardar essas variáveis globalmente
 
  let wordsForTiming = [];           // array de palavras "limpas"
  let cumulativeCharCounts = [];     // soma cumulativa de caracteres
  let totalChars = 0;                // total de caracteres (sem espaços/pontuação)
  
  // Função que prepara o "mapa" de caracteres para sincronização
  function prepareCharMapping(rawText) {
    // 1) Colocar tudo em minúsculo
    let lowerText = rawText.toLowerCase();
    // 2) Remover pontuação que não queremos
    //    Aqui um regex simples que remove tudo que não for letra, número, apóstrofo ou espaço
    let cleanText = lowerText.replace(/[^\p{L}\p{M}\d'\s-]/gu, ''); 
    //    (use \p{L} e \p{M} para letras/unicode, se precisar de regex que suporte acentos)

    // 3) Split em palavras
    wordsForTiming = cleanText.split(/\s+/).filter(Boolean);

    // 4) Calcular a contagem total de caracteres
    totalChars = 0;
    wordsForTiming.forEach((w) => {
      totalChars += w.length;
    });

    // 5) Construir array cumulativo
    cumulativeCharCounts = [];
    let sumSoFar = 0;
    for (let i = 0; i < wordsForTiming.length; i++) {
      sumSoFar += wordsForTiming[i].length;
      cumulativeCharCounts.push(sumSoFar);
    }
  }

  // Função que, dada a wordIndex, calcula ~onde no áudio devemos ir
  function goToWordCharBased(index) {
    const audioElement = document.getElementById("ttsAudio");
    if (!audioLoaded || isNaN(audioElement.duration) || audioElement.duration === Infinity) {
      console.warn("Áudio não está pronto para seek!");
      return;
    }
    if (index < 0 || index >= wordsForTiming.length) {
      console.warn("Índice de palavra fora do range!");
      return;
    }
    
    const duration = audioElement.duration;
    // Descobrimos quantos caracteres se passaram até a *início* dessa palavra
    // Se index=0, então não avançamos nada
    let charsBefore = index === 0 ? 0 : cumulativeCharCounts[index - 1];
    if (totalChars <= 0) {
      // Evitar divisão por zero
      audioElement.currentTime = 0;
    } else {
      let ratio = charsBefore / totalChars;
      audioElement.currentTime = ratio * duration;
    }
    audioElement.play();
  }



      let textWords = [];
      let audioLoaded = false;

      // Guardamos pronunciations retornadas pelo /upload, para exibir feedback
      window.pronunciations = {};

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const categorySelect = document.getElementById("category");
        const options = categorySelect.options;
        const randomIndex = Math.floor(Math.random() * options.length);
        categorySelect.selectedIndex = randomIndex;

        // Áudio
        const ttsAudio = document.getElementById("ttsAudio");
        ttsAudio.addEventListener("loadedmetadata", () => {
          audioLoaded = true;
          console.log("Áudio TTS carregado. Duração: ", ttsAudio.duration);
        });
      });

      function disableButtons() {
        document.getElementById("speakButton").disabled = true;
        document.getElementById("generateButton").disabled = true;
        document.getElementById("recordButton").disabled = true;
      }
      function enableButtons() {
        document.getElementById("speakButton").disabled = false;
        document.getElementById("generateButton").disabled = false;
        document.getElementById("recordButton").disabled = false;
      }
      function showMessage(message) {
        let statusMessage = document.getElementById("statusMessage");
        statusMessage.innerText = message;
        statusMessage.style.display = "block";
      }
      function hideMessage() {
        let statusMessage = document.getElementById("statusMessage");
        statusMessage.style.display = "none";
      }

      document.getElementById("text").addEventListener("input", function () {
        fetchPronunciation(this.value);
      });

      function fetchPronunciation(text) {
        fetch("/pronounce", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "text=" + encodeURIComponent(text),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Erro no servidor /pronounce: " + response.status
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error("Erro /pronounce:", data.error);
              return;
            }

            if (!data.pronunciations) {
              console.warn("pronunciations não veio na resposta:", data);
              return;
            }
            prepareCharMapping(text);
            const splitted = data.pronunciations.split(/\s+/);
            textWords = splitted;

            const pronunciationHtml = splitted
              .map((w) => `<span class="word">${escapeHtml(w)}</span>`)
              .join(" ");

            document.getElementById("pronunciation").innerHTML =
              pronunciationHtml;

            // Agora busca "hints"
            return fetch("/hints", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: "text=" + encodeURIComponent(text),
            });
          })
          .then((response) => {
            if (!response) return;
            if (!response.ok) {
              throw new Error("Erro no servidor /hints: " + response.status);
            }
            return response.json();
          })
          .then((hintsData) => {
            if (!hintsData) return;
            if (hintsData.error) {
              console.error("Erro /hints:", hintsData.error);
              return;
            }

            const hintsList = document.getElementById("hintsList");
            hintsList.innerHTML = "";

            const hints = hintsData.hints || [];
            if (hints.length > 0) {
              hints.forEach((hintItem) => {
                const listItem = document.createElement("li");
                const explanationsStr = hintItem.explanations.join(" ");
                listItem.innerHTML = `<strong>${hintItem.highlighted_word}:</strong> ${explanationsStr}<hr>`;
                hintsList.appendChild(listItem);
              });
            } else {
              hintsList.innerHTML = "<li>Aucune suggestion supplémentaire.</li>";
            }
          })
          .catch((error) => {
            console.error("Erro /pronounce ou /hints:", error);
          });
      }

      function speakText() {
        const text = document.getElementById("text").value;
        disableButtons();
        showMessage("Lecture du texte en cours...");

        fetch("/speak", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "text=" + encodeURIComponent(text),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Erro no servidor /speak: " + response.status);
            }
            return response.blob();
          })
          .then((blob) => {
            let url = URL.createObjectURL(blob);
            let audioElement = document.getElementById("ttsAudio");
            audioElement.src = url;

            audioElement.play();
            audioElement.onended = function () {
              enableButtons();
              hideMessage();
            };
          })
          .catch((error) => {
            console.error("Erro no TTS:", error);
            enableButtons();
            hideMessage();
          });
      }

      // Ao clicar numa palavra no "pronunciation" ou no "diff"
      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("word")) {
          const clickedWord = event.target.innerText;
          // Descobrir índice dessa span
          const parent = event.target.parentNode; // p.ex. #pronunciation ou #diff
          let spans = parent.querySelectorAll(".word");
          spans = Array.from(spans);
          const wordIndex = spans.indexOf(event.target);

          // Mostra pronúncia no feedback
          showPronunciation(clickedWord);
          // Avança no áudio
          goToWordCharBased(wordIndex);
        }
      });

      // Avançar no áudio para a "wordIndex"
      function goToWord(wordIndex) {
        const audioElement = document.getElementById("ttsAudio");
        const duration = audioElement.duration;
        if (!audioLoaded || isNaN(duration) || duration === Infinity) {
          console.warn("Áudio não está pronto para seek!");
          return;
        }
        let totalWords = textWords.length;
        if (totalWords < 1) return;
        let timePerWord = duration / totalWords;
        let seekTime = timePerWord * wordIndex;
        if (seekTime >= duration) {
          seekTime = duration - 0.1;
        }
        audioElement.currentTime = seekTime;
        audioElement.play();
      }

      // Mostra no feedbackBox a pronúncia correta e a do usuário
      function showPronunciation(word) {
        // Precisamos do window.pronunciations (retornado por /upload)
        let p = window.pronunciations[word];
        if (!p) {
          // Pode ser que ainda não tenha feedback para essa palavra
          document.getElementById("feedbackContent").innerHTML = `
            <strong>Mot cliqué:</strong> ${escapeHtml(word)}<br>
            Aucune information de prononciation.<br>
          `;
          return;
        }

        let correct = p.correct || "";
        let user = p.user || "";

        document.getElementById("feedbackContent").innerHTML = `
          <h1>FeedBack:<h1/>
          <strong>Mot:</strong> ${escapeHtml(word)}<br>
          <strong>Prononciation correcte:</strong> ${escapeHtml(correct)}<br>
          <strong>Votre prononciation:</strong> ${
            user ? escapeHtml(user) : "<em>(não pronunciou)</em>"
          }
        `;
      }

      // Função para enviar gravação ou regravação
      function uploadAudio() {
        let audioInput = document.getElementById("audio");
        let textInput = document.getElementById("text");
        let formData = new FormData();
        formData.append("audio", audioInput.files[0]);
        formData.append("text", textInput.value);

        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("ratio").innerText = data.ratio || "";
            document.getElementById("completeness").innerText =
              data.completeness_score || "";
            document.getElementById("diff").innerHTML = data.diff_html || "";
            // Armazena pronunciations e feedback
            window.pronunciations = data.pronunciations || {};
          })
          .catch((error) => {
            console.error("Erro no /upload:", error);
          });
      }

      let mediaRecorder;
      let recordedBlobs;
      let isRecording = false;

      function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      function startRecording() {
        recordedBlobs = [];
        let options = { mimeType: "audio/webm" };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options = { mimeType: "audio/webm;codecs=opus" };
          if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options = { mimeType: "audio/ogg;codecs=opus" };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
              options = { mimeType: "" };
            }
          }
        }

        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.onstop = (event) => {
              const blob = new Blob(recordedBlobs, { type: "audio/webm" });
              const url = window.URL.createObjectURL(blob);
              const audioContainer = document.getElementById("audioContainer");
              audioContainer.innerHTML = "";
              const audio = document.createElement("audio");
              audio.controls = true;
              audio.src = url;
              audioContainer.appendChild(audio);

              uploadRecording(blob);
            };

            mediaRecorder.ondataavailable = (event) => {
              if (event.data && event.data.size > 0) {
                recordedBlobs.push(event.data);
              }
            };

            mediaRecorder.start();
            document.getElementById("recordButton").classList.add("recording");
            document.getElementById("recordIcon").innerText = "pause";
            isRecording = true;
          })
          .catch((error) => {
            console.error("Erreur micro:", error);
            alert("Erreur micro. Permissions?");
          });
      }

      function stopRecording() {
        mediaRecorder.stop();
        document.getElementById("recordButton").classList.remove("recording");
        document.getElementById("recordIcon").innerText = "mic";
        isRecording = false;
      }

      function uploadRecording(blob) {
        document.getElementById("uploadingMessage").style.display = "block";
        document.getElementById("recordButton").disabled = true;

        convertToWav(blob)
          .then((wavBlob) => {
            let textInput = document.getElementById("text");
            let formData = new FormData();
            formData.append("audio", wavBlob, "recording.wav");
            formData.append("text", textInput.value);
            formData.append(
              "category",
              textInput.dataset.category || "random"
            );

            let xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);

            xhr.upload.addEventListener("progress", function (e) {
              if (e.lengthComputable) {
                let percentComplete = (e.loaded / e.total) * 100;
                document.getElementById("uploadProgress").value =
                  percentComplete;
                document.getElementById("uploadingText").innerText = `Envoi de l’audio... ${Math.round(
                  percentComplete
                )}% terminé.`;
              }
            });

            xhr.onload = function () {
              if (xhr.status === 200) {
                let data = JSON.parse(xhr.responseText);
                document.getElementById("ratio").innerText = data.ratio;
                document.getElementById("completeness").innerText =
                  data.completeness_score;
                document.getElementById("diff").innerHTML = data.diff_html;
                window.pronunciations = data.pronunciations || {};

                document.getElementById("uploadingMessage").style.display =
                  "none";
                document.getElementById("recordButton").disabled = false;
              } else {
                handleUploadError(xhr);
              }
            };

            xhr.onerror = function () {
              handleUploadError(xhr);
            };

            xhr.send(formData);
          })
          .catch((error) => {
            document.getElementById("uploadingMessage").style.display = "none";
            document.getElementById("recordButton").disabled = false;
            alert("Erro ao enviar o áudio.");
          });
      }

      function handleUploadError(xhr) {
        console.error("Erro no envio do áudio:", xhr);
        document.getElementById("uploadingText").innerText =
          "Erro no envio do áudio. Tente novamente.";
        document.getElementById("uploadingMessage").style.display = "none";
        document.getElementById("recordButton").disabled = false;
      }

      async function convertToWav(blob) {
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const arrayBuffer = await blob.arrayBuffer();
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          const wavBuffer = audioBufferToWav(audioBuffer);
          return new Blob([wavBuffer], { type: "audio/wav" });
        } catch (error) {
          console.error("Erro conversão WAV:", error);
          throw error;
        }
      }

      function audioBufferToWav(buffer) {
        const numOfChan = buffer.numberOfChannels,
          length = buffer.length * numOfChan * 2 + 44,
          bufferArr = new ArrayBuffer(length),
          view = new DataView(bufferArr),
          channels = [],
          sampleRate = buffer.sampleRate;
        let pos = 0;

        function setUint16(data) {
          view.setUint16(pos, data, true);
          pos += 2;
        }
        function setUint32(data) {
          view.setUint32(pos, data, true);
          pos += 4;
        }

        // RIFF chunk
        setUint32(0x46464952); // "RIFF"
        setUint32(length - 8); // file length - 8
        setUint32(0x45564157); // "WAVE"

        // fmt chunk
        setUint32(0x20746d66); // "fmt "
        setUint32(16); // subchunk size
        setUint16(1); // audio format (1 = PCM)
        setUint16(numOfChan);
        setUint32(sampleRate);
        setUint32(sampleRate * 2 * numOfChan);
        setUint16(numOfChan * 2);
        setUint16(16);

        // data chunk
        setUint32(0x61746164); // "data"
        setUint32(length - pos - 4);

        for (let i = 0; i < numOfChan; i++) {
          channels.push(buffer.getChannelData(i));
        }

        let offset = 0;
        while (pos < length) {
          for (let i = 0; i < numOfChan; i++) {
            const sample = Math.max(-1, Math.min(1, channels[i][offset]));
            view.setInt16(
              pos,
              sample < 0 ? sample * 0x8000 : sample * 0x7fff,
              true
            );
            pos += 2;
          }
          offset++;
        }
        return bufferArr;
      }

      function generateSentence() {
        let category = document.getElementById("category").value;
        disableButtons();
        showMessage("Génération de la phrase...");

        fetch("/get_sentence", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "category=" + encodeURIComponent(category),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Erro na resposta /get_sentence");
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              document.getElementById("text").value = data.fr_sentence;
              document.getElementById("text").dataset.category = data.category;
              fetchPronunciation(data.fr_sentence);
              prepareCharMapping(data.fr_sentence);
            }
          })
          .catch((error) => {
            console.error("Erreur:", error);
            alert("Une erreur est survenue.");
          })
          .finally(() => {
            enableButtons();
            hideMessage();
          });
      }
    </script>
  </body>
</html>