<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Entraîneur de prononciation IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <script
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
      type="text/javascript"
    ></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <meta
      name="description"
      content="Treinador de Pronúncia de IA – Pratique falar francês com feedback instantâneo de pronúncia e dicas."
    />
    <meta
      name="keywords"
      content="Pronúncia francesa, treinamento oral, FLE, DELF"
    />
    <link rel="canonical" href="treinadordepronunciadefrances.up.railway.app" />
    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Entraîneur de prononciation" />
    <meta
      property="og:description"
      content="Melhore sua pronúncia em francês."
    />
    <meta
      property="og:image"
      content="https://firebasestorage.googleapis.com/v0/b/banco-de-dados-abc12.firebasestorage.app/o/Screenshot%202025-04-21%20at%2016.10.10.png?alt=media&token=c7909ac1-a11c-4307-8727-24719bb260d0"
    />
    <meta property="og:url" content="treinadordepronunciadefrances.up.railway.app" />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7645741188042839"
     crossorigin="anonymous"></script>
     
   
  </head>

  <body>
    <main  role="main" class="container">
      <div>
        <section class="main-content">
          <header class="header-box container my-4 p-4 position-relative text-center">
            <!-- ícone à esquerda -->
            <img
              src="https://firebasestorage.googleapis.com/v0/b/banco-de-dados-abc12.firebasestorage.app/o/iconeFranca.svg?alt=media&token=3a4e7282-5ce2-42e0-b5d0-2eab8bacf42f"
              alt="Ícone França"
              class="position-absolute start-0 top-50 translate-middle"
              style="width: 40px;margin-left: 30px;"
            />
          
            <!-- título central -->
            <h1 class="mb-4">Treinador de Pronúncia</h1>
          
            <!-- ícone à direita -->
            <img
              src="https://firebasestorage.googleapis.com/v0/b/banco-de-dados-abc12.firebasestorage.app/o/iconeFranca.svg?alt=media&token=3a4e7282-5ce2-42e0-b5d0-2eab8bacf42f"
              alt="Ícone França"
              class="position-absolute end-0 top-50 translate-middle"
              style="width: 40px; height: auto;"
            />
          
            <p class="lead">
              Pratique sua pronúncia com feedback instantâneo em francês.
            </p>
          </header>
          
         

          <div class="mb-3">
            <label for="category" class="form-label"
              >Selecione uma categoria :</label
            >
             <select class="form-select" id="category" name="category">
              <!-- Cuisine et transport -->
              <optgroup label="Pharses Metro-boulout-dôdo">
                <option value="transport">Transport(Transporte)</option>
                <option value="aeroport">"Aeroport(Aeroporto)</option>
                <option value="rue">Rue(Na rua)</option>
                <option value="hotel">Hotel(No hotel)</option>
                <option value="restaurant">Restaurant(No Restaurante)</option>
                <option value="magasin">Magasin(Lojas)</option>
                <option value="supermarche">Supermarche(Mercado)</option>
                <option value="pharmacie">Pharmacie(Farmácia)</option>
                <option value="police">Police(Policia)</option>
                <option value="musee">Musee(Museu)</option>
              </optgroup>

              <!-- Autres -->
              <optgroup label="Autres">
                 <option value="PROPOSER">
                  Comment faire une preposition 
                </option>
                 <option value="REPONDRE_POSITIVEMENT">
                  Répondre à quelqun de manière positif 
                </option>
                <option value="REPONDRE_NÉGATIVEMENT">
                  Répondre à quelqun de manière négatif
                </option>
                 <option value="DEMANDER_DES_INFORMATIONS">
                  Comment demander des informations 
                </option>
                <option value="DEMANDER_DE_L’AIDE">
                   Comment demander d'aide  
                </option>
                <option value="Connecteurs">
                  Phrases en utilisant des Connecteurs lógiques 
                </option>

                <option value="Donner_la_date">
                  Donner la date (Dar a data)
                </option>
                <option value="Donner_l_heure">
                  Donner l'heure (Dar a hora)
                </option>
                <option value="Indiquer_la_frequence">
                  Indiquer la fréquence (Indicar a frequência)
                </option>
                <option value="Exprimer_une_condition">
                  Exprimer une condition (Expressar uma condição)
                </option>
                <option value="Donner_un_conseil">
                  Donner un conseil (Dar um conselho)
                </option>
                <option value="Exprimer_la_condition">
                  Exprimer la condition (Expressar a condição)
                </option>
                <option value="Exprimer_un_souhait">
                  Exprimer un souhait (Expressar um desejo)
                </option>
                <option value="Exprimer_ses_emotions_et_ses_sentiments">
                  Exprimer ses émotions et ses sentiments (Expressar suas
                  emoções e sentimentos)
                </option>
                <option value="Situer_dans_le_temps_et_exprimer_la_duree">
                  Situer dans le temps et exprimer la durée (Situar no tempo e
                  expressar a duração)
                </option>
                <option value="Parler_d_Internet_et_des_reseaux_sociaux">
                  Parler d'Internet et des réseaux sociaux (Falar da Internet e
                  das redes sociais)
                </option>
                <option value="comparatif">
                  Le comparatif (O comparativo)
                </option>
                <option value="superlatif">
                  Le superlatif (O superlativo)
                </option>
                <option value="formation_des_adverbes">
                  formation des adverbes (Formação dos advérbios)
                </option>
                <option value="negation">La negation (A negação)</option>
              </optgroup>

              <!-- Grammaire -->
              <optgroup label="Grammaire">
                <option value="Expressions_en_Conditionnel_Present">
                  Expressions en Conditionnel Présent
                </option>
                <option value="Expressions_avec_pronom_Y">
                  Expressions_avec_pronom_Y
                </option>
                <option value="Expressions_avec_pronom_EN">
                  Expressions_avec_pronom_EN
                </option>
                <option value="Subjonctif_sentences">
                  Expressions en Subjonctif
                </option>
                <option value="Expressions_en_Imperatif">
                  Expressions en Impératif
                </option>
                <option value="Expressions_en_Futur_Simple">
                  Expressions en Futur Simple
                </option>
                <option value="Expressions_en_Passe_Compose">
                  Expressions en Passé Composé
                </option>
                <option value="Expressions_en_Present_Continu_Gerondif">
                  Expressions en Présent Continu / Gérondif
                </option>
                <option value="Expressions_en_Passe_Recent">
                  Expressions en Passé Récent
                </option>
                <option value="Expressions_en_Imparfait">
                  Expressions en Imparfait
                </option>
                <option value="Expressions_en_Plus_Que_Parfait">
                  Expressions en Plus-Que-Parfait
                </option>
                <option value="Expressions_en_Futur_Proche">
                  Expressions en Futur Proche
                </option>
                <option value="Phrases_avec_de">Phrases avec "de"</option>
                <option value="Phrases_avec_a">Phrases avec "à"</option>
                <option value="Phrases_avec_en">Phrases avec "en"</option>
                <option value="Phrases_avec_COI">Phrases avec COI</option>
                <option value="Phrases_avec_COD">Phrases avec COD</option>
                <option value="Connecteurs">Connecteurs</option>
                <option value="Conjugaison3">Conjugaison 3</option>
                <option value="Conjugaison2">Conjugaison 2</option>
                <option value="Pronominaux">Pronominaux</option>
                <option value="Phrases_avec_y">Phrases avec "y"</option>
              </optgroup>
            </select>

          </div>

          <div class="mb-3">
            <label for="text" class="form-label"
              >Escreve ou gere um texto clicando no botão abaixo :</label
            >
            <textarea class="form-control" id="text" name="text"></textarea>
          </div>

          <div class="classButton">
            <p
              id="statusMessage"
              style="
                display: none;
                font-weight: bold;
                color: red;
                text-align: center;
                font-size: 12px;
              "
            ></p>
            <button
              class="btn btn-success"
              id="generateButton"
              onclick="generateSentence()"
            >
              Gerar uma frase
            </button>
            <button
              class="btn btn-primary"
              id="speakButton"
              onclick="speakText()"
            >
              Escutar o texto
            </button>
          </div>

          <div class="pronunciation-feedback mt-4">
            <h3 class="form-label">Pronunciação:</h3>
            <h3 id="pronunciation"></h3>
          </div>

          <div id="hintsContainer" class="mt-3">
            <h4>Dicas de pronunciação:</h4>
            <ul id="hintsList" class="pronunciation-list"></ul>
          </div>

          <div id="audioContainer" class="mt-4"></div>
        </section>
       
      </div>
    </main>

    <script>
      // Função para escapar caracteres HTML
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const categorySelect = document.getElementById("category");
        const options = categorySelect.options;
        const randomIndex = Math.floor(Math.random() * options.length);

        // Define uma opção aleatória
        categorySelect.selectedIndex = randomIndex;
        
        // Inicializa as vozes
        initVoices();
      });

      // Funções auxiliares para desabilitar/habilitar botões e mostrar/ocultar mensagens
      function disableButtons() {
        document.getElementById("speakButton").disabled = true;
        document.getElementById("generateButton").disabled = true;
      }

      function enableButtons() {
        document.getElementById("speakButton").disabled = false;
        document.getElementById("generateButton").disabled = false;
      }

      function showMessage(message) {
        let statusMessage = document.getElementById("statusMessage");
        statusMessage.innerText = message;
        statusMessage.style.display = "block";
      }

      function hideMessage() {
        let statusMessage = document.getElementById("statusMessage");
        statusMessage.style.display = "none";
      }

      document.getElementById("text").addEventListener("input", function () {
        fetchPronunciation(this.value);
      });

      function fetchPronunciation(text) {
        fetch("/pronounce", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "text=" + encodeURIComponent(text),
        })
          .then((response) => {
            if (!response.ok) {
              // Se o servidor retornar, por exemplo, 500 ou outro erro
              throw new Error(
                "Erro no servidor /pronounce: " + response.status
              );
            }
            return response.json();
          })
          .then((data) => {
            // Verifica se a resposta contém um campo "error"
            if (data.error) {
              console.error(
                "Erro retornado pelo servidor /pronounce:",
                data.error
              );
              // Aqui você pode exibir uma mensagem de erro na tela, se quiser
              return; // Encerra a função, não prossegue
            }

            // Verifica se data.pronunciations existe
            if (!data.pronunciations) {
              console.warn("pronunciations não veio na resposta. data =", data);
              return; // Encerra a função
            }

            // Agora sim podemos usar .split
            const pronunciations = data.pronunciations;
            document.getElementById("pronunciation").innerText = pronunciations;
          })
          .catch((error) => {
            console.error("Erro ao buscar pronúncia:", error);
          });

        // Busca dicas de pronúncia
        fetch("/hints", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "text=" + encodeURIComponent(text),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              console.error("Erro retornado pelo servidor /hints:", data.error);
              return;
            }

            const hintsList = document.getElementById("hintsList");
            hintsList.innerHTML = ""; // Limpa a lista

            if (data.hints && data.hints.length > 0) {
              data.hints.forEach((hint) => {
                const li = document.createElement("li");
                // Importante: Usar innerHTML em vez de innerText para renderizar as tags HTML
                li.innerHTML = `<strong>${escapeHtml(hint.word)}</strong>: ${hint.explanations.join(", ")}`;
                hintsList.appendChild(li);
              });
            } else {
              hintsList.innerHTML = "<li>Nenhuma dica disponível.</li>";
            }
          })
          .catch((error) => {
            console.error("Erro ao buscar dicas:", error);
          });
      }

      function generateSentence() {
        disableButtons();
        showMessage("Gerando frase...");

        const category = document.getElementById("category").value;

        fetch("/get_sentence", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "category=" + encodeURIComponent(category),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              console.error(
                "Erro retornado pelo servidor /get_sentence:",
                data.error
              );
              showMessage("Erro ao gerar frase. Tente novamente.");
              return;
            }

            document.getElementById("text").value = data.fr_sentence;
            fetchPronunciation(data.fr_sentence);
            hideMessage();
          })
          .catch((error) => {
            console.error("Erro ao gerar frase:", error);
            showMessage("Erro ao gerar frase. Tente novamente.");
          })
          .finally(() => {
            enableButtons();
          });
      }

      // Variáveis globais para armazenar as vozes
      let allVoices = [];
      let frenchVoices = [];
      let voicesLoaded = false;
      let voiceLoadAttempts = 0;
      const MAX_VOICE_LOAD_ATTEMPTS = 5;

      // Inicializa as vozes
      function initVoices() {
        // Função para processar as vozes quando estiverem disponíveis
        function processVoices() {
          allVoices = window.speechSynthesis.getVoices();
          
          // Filtrar vozes francesas
          frenchVoices = allVoices.filter(voice => 
            voice.lang.startsWith('fr') || 
            voice.name.toLowerCase().includes('french') || 
            voice.name.toLowerCase().includes('français')
          );
          
          console.log("Vozes disponíveis:", allVoices.length);
          console.log("Vozes francesas encontradas:", frenchVoices.length);
          
          if (frenchVoices.length > 0) {
            frenchVoices.forEach(voice => {
              console.log(`Voz francesa: ${voice.name} (${voice.lang}), Local: ${voice.localService}`);
            });
            voicesLoaded = true;
          } else {
            console.warn("Nenhuma voz francesa encontrada!");
            
            // Tentar novamente se não encontrou vozes francesas
            if (voiceLoadAttempts < MAX_VOICE_LOAD_ATTEMPTS) {
              voiceLoadAttempts++;
              console.log(`Tentativa ${voiceLoadAttempts} de carregar vozes francesas...`);
              setTimeout(processVoices, 500);
            }
          }
        }

        // Para Chrome e Edge
        if (window.speechSynthesis) {
          if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = processVoices;
          }
          
          // Tenta carregar as vozes imediatamente (para Safari)
          setTimeout(() => {
            if (!voicesLoaded) {
              processVoices();
            }
          }, 100);
          
          // Força a inicialização das vozes
          window.speechSynthesis.cancel();
        }
      }

      // Função para encontrar a melhor voz francesa disponível
      function getBestFrenchVoice() {
        if (frenchVoices.length === 0) {
          // Se ainda não carregou as vozes, tenta carregar novamente
          allVoices = window.speechSynthesis.getVoices();
          frenchVoices = allVoices.filter(voice => 
            voice.lang.startsWith('fr') || 
            voice.name.toLowerCase().includes('french') || 
            voice.name.toLowerCase().includes('français')
          );
        }
        
        if (frenchVoices.length === 0) {
          console.warn("Nenhuma voz francesa encontrada após nova tentativa.");
          
          // Último recurso: procurar por qualquer voz que possa ser usada
          const browserLanguage = navigator.language || navigator.userLanguage;
          console.log("Idioma do navegador:", browserLanguage);
          
          // Tentar encontrar uma voz no idioma do navegador
          if (browserLanguage.startsWith('fr')) {
            const browserVoices = allVoices.filter(voice => voice.lang.startsWith(browserLanguage));
            if (browserVoices.length > 0) {
              console.log(`Usando voz do idioma do navegador: ${browserVoices[0].name}`);
              return browserVoices[0];
            }
          }
          
          // Se não encontrar nenhuma voz francesa, usar a primeira voz disponível
          if (allVoices.length > 0) {
            console.log(`Usando primeira voz disponível: ${allVoices[0].name}`);
            return allVoices[0];
          }
          
          return null;
        }
        
        // Prioridade 1: Vozes francesas nativas (localService: true)
        const nativeFrenchVoices = frenchVoices.filter(voice => voice.localService);
        if (nativeFrenchVoices.length > 0) {
          return nativeFrenchVoices[0];
        }
        
        // Prioridade 2: Vozes com código de idioma fr-FR
        const frFRVoices = frenchVoices.filter(voice => voice.lang === 'fr-FR');
        if (frFRVoices.length > 0) {
          return frFRVoices[0];
        }
        
        // Prioridade 3: Qualquer voz francesa
        return frenchVoices[0];
      }

      // Implementação da síntese de voz usando Web Speech API
      function speakText() {
        const text = document.getElementById("text").value.trim();
        
        if (!text) {
          showMessage("Por favor, insira ou gere um texto para ouvir.");
          return;
        }
        
        // Verifica se o navegador suporta a API de síntese de voz
        if ('speechSynthesis' in window) {
          disableButtons();
          showMessage("Reproduzindo áudio...");
          
          // Cancela qualquer fala anterior
          window.speechSynthesis.cancel();
          
          // Cria um novo objeto de fala
          const utterance = new SpeechSynthesisUtterance(text);
          
          // Define o idioma como francês
          utterance.lang = 'fr-FR';
          
          // Tenta obter a melhor voz francesa
          //const bestVoice = getBestFrenchVoice();
          const bestVoice = getBestFrenchVoice();
          
          if (bestVoice) {
            utterance.voice = bestVoice;
            console.log(`Usando voz francesa: ${bestVoice.name} (${bestVoice.lang})`);
          } else {
            console.warn("Nenhuma voz francesa encontrada. Usando configuração padrão com idioma fr-FR.");
          }
          
          // Ajusta a taxa e o tom para melhorar a qualidade
          utterance.rate = 0.9;  // Um pouco mais lento que o normal
          utterance.pitch = 1.0; // Tom normal
          
          // Configura eventos para saber quando a fala terminou
          utterance.onend = function() {
            console.log("Síntese de voz concluída com sucesso");
            enableButtons();
            hideMessage();
          };
          
          utterance.onerror = function(event) {
            console.error("Erro na síntese de voz:", event);
            showMessage("Erro ao reproduzir áudio. Tente novamente.");
            enableButtons();
          };
          
          // Inicia a síntese de voz
          window.speechSynthesis.speak(utterance);
          
          // Workaround para o bug do Chrome/Edge que para após 15 segundos
          if (navigator.userAgent.indexOf('Chrome') !== -1 || navigator.userAgent.indexOf('Edge') !== -1) {
            const resumeInfinity = setInterval(() => {
              if (!window.speechSynthesis.speaking) {
                clearInterval(resumeInfinity);
                return;
              }
              window.speechSynthesis.pause();
              window.speechSynthesis.resume();
            }, 10000);
          }
          
          // Workaround para Safari que às vezes não inicia a fala
          if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
            setTimeout(() => {
              if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
              }
            }, 250);
            
            // Workaround adicional para Safari - forçar a seleção de voz
            if (!utterance.voice) {
              const safariVoices = window.speechSynthesis.getVoices();
              const frenchSafariVoice = safariVoices.find(v => v.lang.startsWith('fr'));
              if (frenchSafariVoice) {
                utterance.voice = frenchSafariVoice;
                console.log("Safari: Forçando voz francesa:", frenchSafariVoice.name);
              }
            }
          }
        } else {
          showMessage("Seu navegador não suporta síntese de voz. Tente usar Chrome, Edge ou Safari.");
        }
      }

      // Adiciona um evento para cancelar a fala se o usuário clicar em outro lugar
      document.addEventListener('click', function(event) {
        // Se o clique não foi no botão de falar e há uma síntese em andamento
        if (event.target.id !== 'speakButton' && window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          enableButtons();
          hideMessage();
        }
      });
      
      // Função para testar as vozes disponíveis
      function testVoices() {
        console.log("Testando vozes disponíveis...");
        const voices = window.speechSynthesis.getVoices();
        console.log(`Total de vozes: ${voices.length}`);
        
        voices.forEach((voice, index) => {
          console.log(`Voz ${index}: ${voice.name} (${voice.lang}), Local: ${voice.localService}`);
        });
        
        // Testar se há vozes francesas
        const frenchVoices = voices.filter(voice => voice.lang.startsWith('fr'));
        console.log(`Vozes francesas: ${frenchVoices.length}`);
        
        frenchVoices.forEach((voice, index) => {
          console.log(`Voz francesa ${index}: ${voice.name} (${voice.lang}), Local: ${voice.localService}`);
        });
        
        return frenchVoices.length > 0;
      }
      
      // Executar teste de vozes após um tempo
      setTimeout(testVoices, 2000);
    </script>
  </body>
</html>
